<div class="container">
  <!-- User Selection Controls -->
  <div class="user-controls">
    <div class="selected-users">
      <h3>{{ 'inventory.table.selectedUsers' | translate }}</h3>
      <div class="user-chips">
        @for (userColumn of userColumns(); track userColumn.userId) {
          <mat-chip-row 
            [removable]="userColumn.userId !== 'WAREHOUSE'"
            (removed)="removeUser(userColumn.userId)"
          >
            <div class="user-chip-content">
              <span class="user-name">{{ userColumn.userName }}</span>
              @if (userColumn.department) {
                <span class="user-department">{{ userColumn.department }}</span>
              }
            </div>
            @if (userColumn.userId !== 'WAREHOUSE') {
              <mat-icon matChipRemove>cancel</mat-icon>
            }
          </mat-chip-row>
        }
      </div>
    </div>

    <div class="user-selection">
      <div class="add-user-section">
        <mat-form-field>
          <mat-label>{{ 'inventory.table.addUser' | translate }}</mat-label>
          <mat-select 
            #userSelect
            [disabled]="isLoadingUsers()"
            (selectionChange)="addUser($event.value); userSelect.value = null"
          >
            @if (isLoadingUsers()) {
              <mat-option disabled>
                {{ 'inventory.users.loading' | translate }}
              </mat-option>
            } @else if (usersError()) {
              <mat-option disabled>
                {{ 'inventory.users.errorLoading' | translate }}
              </mat-option>
            } @else if (!hasUsers()) {
              <mat-option disabled>
                {{ 'inventory.users.noUsers' | translate }}
              </mat-option>
            } @else {
              @for (user of availableUsersForSelection(); track user.user.id) {
                <mat-option [value]="user.user.id">
                  <app-user-display [user]="user" />
                </mat-option>
              }
            }
          </mat-select>
        </mat-form-field>
      </div>

      <div class="action-buttons">
        <button 
          mat-button 
          color="primary"
          (click)="showAllUsers()"
          [disabled]="!hasUsers() || isLoadingUsers()"
        >
          {{ 'inventory.table.showAllUsers' | translate }}
        </button>
        
        <button 
          mat-button
          (click)="resetToWarehouse()"
          [disabled]="selectedUserIds().length === 1 && selectedUserIds()[0] === 'WAREHOUSE'"
        >
          {{ 'inventory.table.resetToWarehouse' | translate }}
        </button>

        @if (productColumnSort().productId) {
          <button 
            mat-button
            color="accent"
            (click)="clearProductColumnSort()"
          >
            Clear Column Sort
          </button>
        }
      </div>
    </div>

    <!-- Error message for users loading -->
    @if (usersError()) {
      <div class="error-message">
        <mat-icon>error</mat-icon>
        <span>{{ 'inventory.users.errorMessage' | translate }}: {{ usersError() }}</span>
        <button mat-button (click)="loadUsers()" color="primary">
          {{ 'common.retry' | translate }}
        </button>
      </div>
    }
  </div>

  <!-- Inventory Table -->
  <div class="table-container">
    @if (tableData().length > 0) {
      <table mat-table [dataSource]="tableData()" class="inventory-table">
        
        <!-- Product Column -->
        <ng-container matColumnDef="product">
          <th mat-header-cell *matHeaderCellDef class="product-header sortable-header" 
              [class.sorted]="isColumnSorted('product')"
              (click)="onHeaderClick('product')">
            <div class="header-content">
              <span>{{ 'inventory.table.product' | translate }}</span>
              <mat-icon class="sort-icon">{{ getSortIcon('product') }}</mat-icon>
            </div>
          </th>
          <td mat-cell *matCellDef="let row" class="product-cell clickable-product" 
              [class.upi-row]="shouldHighlightUpiRow(row)"
              [class.sorting-columns]="isProductSortingColumns(row.product.id)"
              (click)="onProductClick(row.product.id)"
              [matTooltip]="'Click to sort user columns by this product'"
              [matTooltipPosition]="'above'">
            <div class="product-info">
              <span class="product-name">{{ row.product.name }}</span>
              <span class="product-id">{{ row.product.id }}</span>
              @if (row.hasUpi) {
                <mat-icon class="upi-indicator" matTooltip="{{ 'inventory.table.upiProduct' | translate }}">
                  key
                </mat-icon>
              }
              @if (isProductSortingColumns(row.product.id)) {
                <span class="sort-indicator">{{ getProductSortIndicator(row.product.id) }}</span>
              }
            </div>
          </td>
        </ng-container>

        <!-- Dynamic User Columns -->
        @for (userColumn of userColumns(); track userColumn.userId) {
          <ng-container [matColumnDef]="userColumn.userId">
            <th mat-header-cell *matHeaderCellDef class="user-header sortable-header"
                [class.sorted]="isColumnSorted(userColumn.userId)"
                (click)="onHeaderClick(userColumn.userId)">
              <div class="user-header-content">
                <div class="user-info">
                  <span class="user-name">{{ userColumn.userName }}</span>
                  @if (userColumn.department) {
                    <span class="user-department">{{ userColumn.department }}</span>
                  }
                </div>
                <mat-icon class="sort-icon">{{ getSortIcon(userColumn.userId) }}</mat-icon>
              </div>
            </th>
            <td mat-cell *matCellDef="let row" 
                class="quantity-cell" 
                [class.upi-cell]="row.userColumns[userColumn.userId]?.upis?.length"
                [class.upi-row]="shouldHighlightUpiRow(row)"
                [matTooltip]="getUpiTooltip(row.userColumns[userColumn.userId])"
                [matTooltipPosition]="'above'"
                [matTooltipClass]="'upi-tooltip'"
            >
              @if (row.userColumns[userColumn.userId]) {
                <div class="quantity-badge">
                  {{ row.userColumns[userColumn.userId].quantity }}
                  @if (row.userColumns[userColumn.userId].upis?.length) {
                    <mat-icon class="upi-icon">key</mat-icon>
                  }
                </div>
              } @else {
                <span class="no-quantity">-</span>
              }
            </td>
          </ng-container>
        }

        <tr mat-header-row *matHeaderRowDef="displayedColumns()"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns();" 
            [class.upi-row]="shouldHighlightUpiRow(row)">
        </tr>
      </table>
    } @else {
      <div class="empty-state">
        <mat-icon>inventory</mat-icon>
        <h3>{{ 'inventory.table.noInventory' | translate }}</h3>
        <p>{{ 'inventory.table.noInventoryDescription' | translate }}</p>
      </div>
    }
  </div>
</div> 